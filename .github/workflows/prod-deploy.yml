name: Production Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  DOCKER_IMAGE: todo-app
  ENVIRONMENT: production

jobs:
  pre-production-validation:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: todo-app/package-lock.json
        
    - name: Install dependencies
      run: |
        cd todo-app
        npm ci
        
    - name: Final validation tests
      run: |
        cd todo-app
        npm run lint
        npm test
        npm audit --audit-level=high
        echo "‚úÖ Pre-production validation passed!"

  production-deploy:
    runs-on: ubuntu-latest
    environment: production
    needs: pre-production-validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build production image
      run: |
        cd todo-app
        docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.ENVIRONMENT }} .
        docker build -t ${{ env.DOCKER_IMAGE }}:latest .
        
    - name: Backup current production (if exists)
      run: |
        # Create backup of current production
        if docker ps -q -f name=prod-todo-app; then
          echo "Creating backup of current production..."
          docker commit prod-todo-app ${{ env.DOCKER_IMAGE }}:backup-$(date +%Y%m%d-%H%M%S)
          echo "‚úÖ Backup created"
        fi
        
    - name: Deploy to production
      run: |
        # Blue-Green deployment simulation
        echo "üöÄ Starting production deployment..."
        
        # Stop old production container
        docker stop prod-todo-app 2>/dev/null || true
        docker rm prod-todo-app 2>/dev/null || true
        
        # Start new production container
        docker run -d -p 3002:3000 --name prod-todo-app \
          --restart unless-stopped \
          ${{ env.DOCKER_IMAGE }}:${{ env.ENVIRONMENT }}
        
        sleep 15
        echo "‚úÖ Production container started"
        
    - name: Production health checks
      run: |
        echo "üè• Running production health checks..."
        
        # Basic health check
        curl -f http://localhost:3002/api/todos || exit 1
        echo "‚úÖ API health check passed"
        
        # UI health check
        curl -f http://localhost:3002/ || exit 1
        echo "‚úÖ UI health check passed"
        
        # Load test (basic)
        for i in {1..10}; do
          curl -s http://localhost:3002/api/todos > /dev/null
          if [ $? -ne 0 ]; then
            echo "‚ùå Load test failed at request $i"
            exit 1
          fi
        done
        echo "‚úÖ Load test passed"
        
    - name: Post-deployment verification
      run: |
        echo "üîç Post-deployment verification..."
        
        # Check container is running
        if ! docker ps | grep -q prod-todo-app; then
          echo "‚ùå Production container not running"
          exit 1
        fi
        
        # Check logs for errors
        LOGS=$(docker logs prod-todo-app 2>&1)
        if echo "$LOGS" | grep -i error; then
          echo "‚ùå Errors found in logs"
          exit 1
        fi
        
        echo "‚úÖ Post-deployment verification passed"
        
    - name: Production deployment summary
      run: |
        echo "üéâ PRODUCTION DEPLOYMENT SUCCESSFUL"
        echo "=================================="
        echo "Environment: ${{ env.ENVIRONMENT }}"
        echo "URL: http://localhost:3002"
        echo "Commit: ${{ github.sha }}"
        echo "Deployed at: $(date)"
        echo "Status: LIVE"

  rollback-plan:
    runs-on: ubuntu-latest
    if: failure()
    needs: [production-deploy]
    
    steps:
    - name: Rollback production
      run: |
        echo "üîÑ INITIATING ROLLBACK..."
        
        # Stop failed deployment
        docker stop prod-todo-app 2>/dev/null || true
        docker rm prod-todo-app 2>/dev/null || true
        
        # Find latest backup
        BACKUP_IMAGE=$(docker images --format "table {{.Repository}}:{{.Tag}}" | grep backup | head -1)
        
        if [ ! -z "$BACKUP_IMAGE" ]; then
          echo "Rolling back to: $BACKUP_IMAGE"
          docker run -d -p 3002:3000 --name prod-todo-app --restart unless-stopped $BACKUP_IMAGE
          echo "‚úÖ Rollback completed"
        else
          echo "‚ùå No backup found for rollback"
        fi
